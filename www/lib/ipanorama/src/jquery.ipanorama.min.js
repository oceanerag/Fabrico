!function(a){"use strict";function b(a,b){this.config=null,this.container=null,this.controls={},this.aspect=null,this.renderer=null,this.scene=null,this.sceneId=null,this.sceneIdArray=[],this.sceneIdThumbsArray=[],this.sceneThumbIndex=0,this.camera=null,this.stereoCamera=null,this.hotSpots=[],this.hotSpotTimerId=null,this.hotSpotTimerDelay=1e3,this.zindex=4,this.popover=!1,this.popoverTemplate=null,this.popoverCloseManual=!1,this.autoRotate={enabled:!1,speed:0},this.yaw={value:0,valuePrev:0,valueNext:0,time:0,duration:0},this.pitch={value:0,valuePrev:0,valueNext:0,time:0,duration:0,min:0,max:0},this.zoom={value:75,valuePrev:0,valueNext:0,time:0,duration:0,min:40,max:100},this.grabControl={enabled:!1,x:0,y:0,pitchSaved:0,yawSaved:0},this.sceneThumbsControl={x:0,y:0,top:0,left:0,topSaved:0,leftSaved:0},this.hoverGrabControl={enabled:!1,pitchSaved:0,yawSaved:0},this.hotSpotSetupControl={enabled:!1,x:0,y:0,pitchSaved:0,yawSaved:0},this.animating=!1,this.loading=!1,this.xhr=null,this.timePrev=null,this.timeNext=null,this.timeInteraction=Date.now(),this.id=e++,this.init(a,b)}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();var c=function(){function a(){}return a.prototype.css2json=function(a){var b={};if(!a)return b;if(a instanceof CSSStyleDeclaration)for(var c in a)a[c].toLowerCase&&(b[a[c].toLowerCase()]=a[a[c]]);else if("string"==typeof a){a=a.split(";");for(var c in a){var d=a[c].split(":");2==d.length&&(b[d[0].toLowerCase().trim()]=d[1].trim())}}return b},a.prototype.webgl=function(){try{var a=document.createElement("canvas");return!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))}catch(b){return!1}},a.prototype.isiOS=function(){var a=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;return a},a.prototype.isMobile=function(a){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(a)},a.prototype.isTransition=function(){for(var a=["transition","MozTransition","WebkitTransition","OTransition","msTransition","KhtmlTransition"],b=document.documentElement,c=0;c<a.length;c++)if(a[c]in b.style)return!0;return!1},a.prototype.animationEvent=function(){var a=document.createElement("fakeelement"),b={animation:"animationend",MSAnimationEnd:"msAnimationEnd",OAnimation:"oAnimationEnd",MozAnimation:"mozAnimationEnd",WebkitAnimation:"webkitAnimationEnd"};for(var c in b)if(void 0!==a.style[c])return b[c]},a}(),d="ipanorama",e=0;b.prototype={VERSION:"1.2.4",defaults:{theme:"ipnrm-theme-default",imagePreview:null,autoLoad:!1,autoRotate:!1,autoRotateSpeed:.001,autoRotateInactivityDelay:3e3,mouseWheelRotate:!1,mouseWheelRotateCoef:.2,mouseWheelZoom:!0,mouseWheelZoomCoef:.05,hoverGrab:!1,hoverGrabYawCoef:20,hoverGrabPitchCoef:20,grab:!0,grabCoef:.1,showControlsOnHover:!1,showSceneThumbsCtrl:!1,showSceneMenuCtrl:!1,showSceneNextPrevCtrl:!0,showShareCtrl:!1,showZoomCtrl:!0,showFullscreenCtrl:!0,sceneThumbsVertical:!0,title:!0,compass:!0,keyboardNav:!0,keyboardZoom:!0,sceneNextPrevLoop:!1,popover:!0,popoverTemplate:"<div class='ipnrm-popover'><div class='ipnrm-close'></div><div class='ipnrm-arrow'></div><div class='ipnrm-content'></div></div>",popoverPlacement:"top",popoverShowTrigger:"hover",popoverHideTrigger:"leave",popoverShowClass:null,popoverHideClass:null,hotSpotBelowPopover:!0,sceneId:null,sceneFadeDuration:3e3,scenes:{defaults:{type:"cube",image:"",thumb:!1,thumbImage:null,yaw:0,pitch:0,zoom:75,title:null,titleSelector:null,titleHtml:!1,compassNorthOffset:null,hotSpots:[]}},pitchLimits:!0,hotSpotSetup:!1,onHotSpotSetup:null,onCameraUpdate:null,onShare:null,mobile:!1},cameraNearClipPlane:.1,cameraFarClipPlane:1e3,init:function(a,b){this.container=a,this.config=b,this.initScenes(),b.autoRotate?(this.autoRotate.enabled=!0,this.autoRotate.speed=b.autoRotateSpeed,this.timeInteraction=Date.now()-this.config.autoRotateInactivityDelay):this.autoRotate.enabled=!1,this.create()},initScenes:function(){for(var c in this.config.scenes)if(this.config.scenes.hasOwnProperty(c)){var d=a.extend({},b.prototype.defaults.scenes.defaults,this.config.scenes[c]);this.config.scenes[c]=d,this.sceneIdArray.push(c),d.thumb&&this.sceneIdThumbsArray.push(c)}},create:function(){this.checkControls(),this.checkAnimation(),this.buildDOM(),this.resetHandlers(),this.util().webgl()?(this.applyHandlers(),this.resetHotSpots(),this.applyPopover(),this.applyHotSpots(),this.config.autoLoad&&(this.controls.$loadBtn.hide(),this.loadScene(this.config.sceneId))):(this.controls.$loadBtn.hide(),this.hideLoadInfo(),this.controls.$info.html("<p>Your browser does not support WebGL</p>"),this.controls.$info.fadeIn())},checkControls:function(){this.sceneIdArray.length>1||(this.config.showSceneNextPrevCtrl=!1)},checkAnimation:function(){var a=!this.config.mobile&&this.util().isMobile(navigator.userAgent);(void 0==this.util().animationEvent()||a)&&(this.config.popoverShowClass=null,this.config.popoverHideClass=null)},loadScene:function(b){if(!this.config.scenes.hasOwnProperty(b))return this.showMessage("<p>Cannot load '"+b+"' scene</p>"),void console.error("Cannot load '"+b+"' scene");if(this.loading&&this.xhr&&4!=this.xhr.readyState&&this.xhr.abort(),this.loading=!0,this.showLoadInfo(),this.sceneId){var c=this.config.scenes[this.sceneId];c.pitch=this.pitch.value,c.yaw=this.yaw.value,c.zoom=this.zoom.value}var c=this.config.scenes[b];this.pitch.value=c.pitch,this.yaw.value=c.yaw,this.zoom.value=Math.max(this.zoom.min,Math.min(this.zoom.max,c.zoom));var d={},e=0,f=0,g={};"string"==typeof c.image?d.image=c.image:c.image.hasOwnProperty("left")&&c.image.hasOwnProperty("right")&&c.image.hasOwnProperty("top")&&c.image.hasOwnProperty("bottom")&&c.image.hasOwnProperty("front")&&c.image.hasOwnProperty("back")?(d.right=c.image.right,d.left=c.image.left,d.top=c.image.top,d.bottom=c.image.bottom,d.front=c.image.front,d.back=c.image.back):(this.controls.$loadInfo.fadeTo("slow",0),this.showMessage("<p>Wrong parameter value for texture</p>"),console.error("Wrong parameter value for texture"));for(var h in d)d.hasOwnProperty(h)&&e++;for(var h in d)if(d.hasOwnProperty(h)){this.xhr=new XMLHttpRequest;var i=this.xhr;i.open("GET",d[h],!0),i.crossOrigin="Anonymous",i.responseType="arraybuffer",i.customKey=h,i.onprogress=a.proxy(function(a){var b=a.currentTarget;if(a.lengthComputable){g[b.customKey]={total:a.total,loaded:a.loaded};var c,d;for(var e in g)g.hasOwnProperty(e)&&(c=g[e].total,d=g[e].loaded);var f=Math.floor(d/c*100)+"%";this.controls.$loadProgressBar.stop().animate({width:f})}},this),i.onload=a.proxy(function(c){var g=c.currentTarget;if(g.status>=400)return g.onerror(c);var h=new Blob([g.response]),i=new Image;i.onload=a.proxy(function(a){d[a.customKey]=i,++f==e&&(this.hideLoadInfo(),this.applyControls(b),this.loading=!1,this.applyPitchLimits(b),this.resetTransition(),this.buildScene(b,d),this.animateStart())},this,g),i.onerror=a.proxy(function(a){++f==e&&(this.hideLoadInfo(),this.showMessage("<p>Cannot load texture</p>"),console.error("Cannot load texture '"+d[a.customKey]+"'"))},this,g),i.src=window.URL.createObjectURL(h)},this),i.onerror=a.proxy(function(a){var b=a.currentTarget;this.hideLoadInfo(),this.showMessage("<p>Cannot load texture</p>"),console.error("Cannot load texture '"+d[b.customKey]+"'")},this),i.send()}},applyPitchLimits:function(a){var b=this.config.scenes[a];this.config.pitchLimits?"cube"==b.type?(this.pitch.min=-70,this.pitch.max=70):"sphere"==b.type?(this.pitch.min=-35,this.pitch.max=35):"cylinder"==b.type&&(this.pitch.min=-5,this.pitch.max=5):(this.pitch.min=-89,this.pitch.max=89)},loadHotSpots:function(a,b){if(!this.config.scenes.hasOwnProperty(a))return void console.error("Cannot load hotspots for the '"+a+"' scene");var c=this.config.scenes[a];c.hotSpots=b,this.resetHotSpots(),this.applyHotSpots(),this.loading||this.controlHotSpots()},applyHotSpots:function(){for(var b in this.config.scenes)if(this.config.scenes.hasOwnProperty(b)){for(var c=this.config.scenes[b],d=JSON.parse(JSON.stringify(c.hotSpots)),e=0,f=d.length;f>e;e++){var g=d[e];if(g.yaw=g.yaw?g.yaw:0,g.pitch=g.pitch?g.pitch:0,g.sceneOwnerId=b,g.xyz=this.getPitchYawPoint(g.pitch,g.yaw),g.visible=!1,g.className?g.$el=a("<div class='ipnrm-hotspot-custom "+g.className+"' style='display: none;'></div>"):g.$el=a("<div class='ipnrm-hotspot' style='display: none;'></div>"),g.content&&g.$el.append(g.content),"boolean"!=typeof g.popoverLazyload&&(g.popoverLazyload=!0),"boolean"!=typeof g.popoverShow&&(g.popoverShow=!1),g.$popover=null,"string"==typeof g.sceneId&&(g.$el.addClass("ipnrm-hotspot-scene"),g.$el.on("click.ipanorama touchstart.ipanorama",a.proxy(this.onHotSpotSceneClick,this,g))),"function"==typeof c.hotSpots[e].popoverContent&&(g.popoverContent=c.hotSpots[e].popoverContent),g.popoverContent||g.popoverSelector){for(var h=this.config.popoverShowTrigger.split(" "),i=h.length;i--;){var j=h[i];"click"==j?g.$el.on("click.ipanorama touchstart.ipanorama",a.proxy(this.onHotSpotClick,this,g)):"hover"==j&&g.$el.on("mouseenter.ipanorama",a.proxy(this.onHotSpotEnter,this,g))}for(var h=this.config.popoverHideTrigger.split(" "),i=h.length;i--;){var j=h[i];"click"==j?g.$el.on("click.ipanorama touchstart.ipanorama",a.proxy(this.onPopoverHide,this,g)):"grab"==j?a("body").add(this.controls.$view).on("mousedown",a.proxy(this.onPopoverHide,this,g)):"leave"==j?g.$el.on("mouseleave.ipanorama",a.proxy(this.onHotSpotLeave,this,g)):"manual"==j&&(this.popoverCloseManual=!0)}}this.controls.$hotspots.append(g.$el),!this.popover||g.popoverLazyload&&!g.popoverShow||(this.createPopover(g),g.popoverShow&&g.$popover.addClass("ipnrm-active"))}this.hotSpots=this.hotSpots.concat(d)}},resetHotSpots:function(){this.controls.$hotspots.children().fadeTo("slow",0,function(){a(this).remove()})},applyPopover:function(){if(this.popover=this.config.popover,this.popover){var b=a(this.config.popoverTemplate);return 1!=b.length?(this.popover=!1,void console.error("'popoverTemplate' option must consist of exactly 1 top-level element!")):void(this.popoverTemplate=this.config.popoverTemplate)}},createPopover:function(b){if(!b.$popover){b.$popover=a(this.popoverTemplate);var c=this.getPopoverUID("popover");b.$popover.attr("id",c),this.popoverCloseManual&&(b.$popover.addClass("ipnrm-close"),b.$popover.find(".ipnrm-close").on("click.ipanorama",a.proxy(this.onPopoverHide,this,b))),b.$popover.on("click.ipanorama",a.proxy(this.onPopoverClick,this,b))}var d=b.$popover;if(!d.hasClass("ipnrm-active")||b.$popover.hasClass(this.config.popoverHideClass)){var e=this.getPopoverContent(b);d.find(".ipnrm-content").children().detach().end()[b.popoverHtml?"string"==typeof e?"html":"append":"text"](e),d.detach().css({top:-9999,left:-9999,width:""}),d.removeClass(this.config.popoverHideClass),d.removeClass(this.config.popoverShowClass),b.popoverWidth&&d.css({"max-width":b.popoverWidth,"min-width":b.popoverWidth}),this.liftupPopover(b),d.appendTo(this.controls.$panorama),d[0].offsetWidth>0&&d.css({width:d[0].offsetWidth}),this.resetHotSpotTimer(),this.hotSpotTimerDelay=600,this.hotSpotTimerId=setTimeout(a.proxy(this.onHotSpotTimer,this),this.hotSpotTimerDelay)}},showPopover:function(b){if(this.popover&&b.visible&&(b.popoverContent||b.popoverSelector)){this.createPopover(b);var c=this.config.popoverPlacement;b.popoverPlacement&&(c=b.popoverPlacement);var d=this.getPopoverPosition(b),e=b.$popover,f=e[0].offsetWidth,g=e[0].offsetHeight,h=this.getPopoverOffset(c,d,f,g);this.applyPopoverPlacement(b,h,c),e.hasClass("ipnrm-active")||(e.removeClass(this.config.popoverHideClass),e.addClass(this.config.popoverShowClass),this.config.popoverShowClass?(b.$popover.css("visibility","visible"),b.$popover.addClass("ipnrm-active").addClass(this.config.popoverShowClass),b.$popover.one(this.util().animationEvent(),a.proxy(function(b){var c=a(b.target);c.hasClass(this.config.popoverHideClass)||c.removeClass(this.config.popoverShowClass),c.css("visibility","")},this))):e.addClass("ipnrm-active"))}},hidePopover:function(b){b.$popover&&(b.$popover.hasClass("ipnrm-active")||b.$popover.hasClass(this.config.popoverShowClass))&&(b.$popover.removeClass(this.config.popoverShowClass),b.$popover.css("z-index",""),b.$el.css("z-index",""),this.config.popoverHideClass?(b.$popover.addClass(this.config.popoverHideClass),b.$popover.one(this.util().animationEvent(),a.proxy(function(c){var d=a(c.target);d.hasClass(this.config.popoverShowClass)||(d.removeClass(this.config.popoverHideClass),this.retachPopover(b.$popover))},this))):this.retachPopover(b.$popover))},retachPopover:function(a){a.removeClass("ipnrm-active"),a.detach(),a.get(0).offsetHeight,a.css({top:-9999,left:-9999,width:""}),a.appendTo(this.controls.$view),0==this.controls.$panorama.find(".ipnrm-popover.ipnrm-active").length&&(this.controls.$panorama.find(".ipnrm-hotspot, .ipnrm-popover").css("z-index",""),this.zindex=4)},liftupPopover:function(a){(this.hotSpots.length>1||a.popoverShow)&&(this.config.hotSpotBelowPopover?(a.$el.css("z-index",this.zindex+1),a.$popover.css("z-index",this.zindex+2)):(a.$el.css("z-index",this.zindex+2),a.$popover.css("z-index",this.zindex+1)),this.zindex=this.zindex+2)},resetHotSpotTimer:function(){this.hotSpotTimerId&&clearTimeout(this.hotSpotTimerId)},onHotSpotTimer:function(){var b=!1;this.hotSpotTimerDelay+=200;for(var c=this.hotSpots.length;c--;){var d=this.hotSpots[c];d.$popover&&d.$popover.hasClass("ipnrm-active")&&!d.$popover.hasClass(this.config.popoverHideClass)&&(b=!0,d.$popover.hasClass(this.config.popoverShowClass)||this.showPopover(d))}this.hotSpotTimerDelay>1800&&(b=!1),b?this.hotSpotTimerId=setTimeout(a.proxy(this.onHotSpotTimer,this),this.hotSpotTimerDelay):this.hotSpotTimerId=null},getPopoverContent:function(b){if(b.popoverContent)return"function"==typeof b.popoverContent?b.popoverContent.call(b):b.popoverContent;if(b.popoverSelector){var c=a(b.popoverSelector);return b.popoverHtml?c.html():c.text()}return""},getPopoverPosition:function(b){var c=b.$el,d=c.get(0),e=d.getBoundingClientRect(),f=c.offset(),g=a.extend({},e,f);return g.top=g.top+g.height/2,g.left=g.left+g.width/2,g},getPopoverOffset:function(a,b,c,d){return"bottom"==a?{top:b.top,left:b.left-c/2}:"top"==a?{top:b.top-d,left:b.left-c/2}:"left"==a?{top:b.top-d/2,left:b.left-c}:"right"==a?{top:b.top-d/2,left:b.left}:"bottom-left"==a?{top:b.top,left:b.left-c}:"bottom-right"==a?{top:b.top,left:b.left}:"top-left"==a?{top:b.top-d,left:b.left-c}:"top-right"==a?{top:b.top-d,left:b.left}:{top:b.top-d,left:b.left-c/2}},applyPopoverPlacement:function(b,c,d){var e=b.$popover,f=(e[0].offsetWidth,e[0].offsetHeight,parseInt(e.css("margin-top"),10)),g=parseInt(e.css("margin-left"),10),h=parseInt(e.css("margin-bottom"),10),i=parseInt(e.css("margin-right"),10);isNaN(f)&&(f=0),isNaN(g)&&(g=0),isNaN(h)&&(h=0),isNaN(i)&&(i=0),c.top+=f-h,c.left+=g-i,a.offset.setOffset(e[0],a.extend({using:function(a){e.css({top:Math.round(a.top),left:Math.round(a.left)})}},c),0);for(var j=["top","left","bottom","right","top-left","top-right","bottom-left","bottom-right"],k=j.length;k--;)if(j[k]==d){j.splice(k,1);break}for(var k=j.length;k--;)e.removeClass("ipnrm-popover-"+j[k]);e.addClass("ipnrm-popover-"+d)},getPopoverUID:function(a){do a+=~~(1e6*Math.random());while(document.getElementById(a));return a},buildDOM:function(){if(this.container.empty(),this.controls.$panorama=a("<div class='ipnrm"+(this.config.theme?" "+this.config.theme:"")+(this.config.showControlsOnHover?" ipnrm-hide-controls":"")+"' tabindex='1'></div>"),this.controls.$view=a("<div class='ipnrm-view'></div>"),this.controls.$preview=a("<div class='ipnrm-preview'></div>"),this.config.imagePreview&&this.controls.$preview.css("background-image","url("+this.config.imagePreview+")"),this.controls.$scene=a("<div class='ipnrm-scene'></div>"),this.controls.$hotspots=a("<div class='ipnrm-hotspots'></div>"),this.setViewCursorShape("ipnrm-grab"),this.controls.$view.append(this.controls.$preview),this.controls.$view.append(this.controls.$scene),this.controls.$view.append(this.controls.$hotspots),this.controls.$loadBtn=a("<div class='ipnrm-btn-load'><p>click to<br>load<br>panorama</p></div>"),this.controls.$loadInfo=a("<div class='ipnrm-load-info' style='display:none'></div>"),this.controls.$loadInfoInner=a("<div class='ipnrm-load-info-inner'><p>Loading</p></div>"),this.controls.$loadProgress=a("<div class='ipnrm-load-progress'></div>"),this.controls.$loadProgressBar=a("<div class='ipnrm-load-progress-bar'></div>"),this.controls.$loadProgress.append(this.controls.$loadProgressBar),this.controls.$loadInfoInner.append(this.controls.$loadProgress),this.controls.$loadInfo.append(this.controls.$loadInfoInner),this.controls.$info=a("<div class='ipnrm-info' style='display:none'></div>"),this.controls.$controls=a("<div class='ipnrm-controls'></div>"),this.controls.$sceneThumbs=a("<div class='ipnrm-scene-thumbs'></div>"),this.controls.$sceneThumbsInner=a("<div class='ipnrm-scene-thumbs-inner'></div>"),this.controls.$toolbar=a("<div class='ipnrm-toolbar' style='display:none'></div>"),this.controls.$sceneMenu=a("<div class='ipnrm-btn-scene-menu ipnrm-btn' style='display:none'></div>"),this.controls.$scenePrev=a("<div class='ipnrm-btn-scene-prev ipnrm-btn' style='display:none'></div>"),this.controls.$sceneNext=a("<div class='ipnrm-btn-scene-next ipnrm-btn' style='display:none'></div>"),this.controls.$zoomIn=a("<div class='ipnrm-btn-zoom-in ipnrm-btn' style='display:none'></div>"),this.controls.$zoomOut=a("<div class='ipnrm-btn-zoom-out ipnrm-btn' style='display:none'></div>"),this.controls.$share=a("<div class='ipnrm-btn-share ipnrm-btn' style='display:none'></div>"),this.controls.$fullscreen=a("<div class='ipnrm-btn-fullscreen ipnrm-btn' style='display:none'></div>"),this.controls.$compass=a("<div class='ipnrm-compass' style='display:none'></div>"),this.controls.$title=a("<div class='ipnrm-title' style='display:none'></div>"),this.config.showSceneThumbsCtrl||this.config.showSceneMenuCtrl){for(var b in this.config.scenes)if(this.config.scenes.hasOwnProperty(b)){var c=this.config.scenes[b];if(c.thumb){var d=a("<div class='ipnrm-scene-thumb'></div>");d.attr("data-sceneid",b),c.thumbImage&&d.append("<img class='ipnrm-scene-thumb-img' src='"+c.thumbImage+"' alt=''>"),this.controls.$sceneThumbsInner.append(d)}}this.controls.$sceneThumbs.append(this.controls.$sceneThumbsInner)}this.controls.$controls.append(this.controls.$sceneThumbs,this.controls.$toolbar,this.controls.$sceneMenu,this.controls.$scenePrev,this.controls.$sceneNext,this.controls.$zoomIn,this.controls.$zoomOut,this.controls.$share,this.controls.$fullscreen,this.controls.$compass,this.controls.$title),this.container.append(this.controls.$panorama),this.controls.$panorama.append(this.controls.$view,this.controls.$loadBtn,this.controls.$loadInfo,this.controls.$info,this.controls.$controls)},buildScene:function(b,c){var d=this.controls.$view.width(),e=this.controls.$view.height();this.sceneId=b,this.aspect=d/e,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(this.zoom.value,this.aspect,this.cameraNearClipPlane,this.cameraFarClipPlane),this.stereoCamera=new THREE.StereoCamera,this.stereoCamera.aspect=.5,this.buildGeomentry(b,c),this.renderer=new THREE.WebGLRenderer,this.renderer.setSize(d,e);var f=a(this.renderer.domElement);f.fadeTo(0,0),this.controls.$scene.append(f),f.fadeTo(this.config.sceneFadeDuration,1,a.proxy(function(){this.controls.$scene.children().length>1&&this.controls.$scene.children(":first-child").remove()},this))},buildGeomentry:function(a,b){var c=this.config.scenes[a];"cube"==c.type?this.buildCube(b):"sphere"==c.type?this.buildSphere(b):"cylinder"==c.type&&this.buildCylinder(b)},buildCube:function(a){var b=new THREE.BoxGeometry(100,100,100);b.scale(-1,1,1);var c=[];c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"right"),side:THREE.FrontSide})),c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"left"),side:THREE.FrontSide})),c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"top"),side:THREE.FrontSide})),c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"bottom"),side:THREE.FrontSide})),c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"front"),side:THREE.FrontSide})),c.push(new THREE.MeshBasicMaterial({map:this.createTexture(a,"back"),side:THREE.FrontSide}));var d=new THREE.MeshFaceMaterial(c),e=new THREE.Mesh(b,d);this.scene.add(e)},buildSphere:function(a){var b=new THREE.SphereGeometry(100,32,32);b.scale(-1,1,1);var c=new THREE.MeshBasicMaterial({side:THREE.FrontSide});a.hasOwnProperty("image")&&(c.map=this.createTexture(a,"image"));var d=new THREE.Mesh(b,c);this.scene.add(d)},buildCylinder:function(a){var b=null,c=null;if(a.hasOwnProperty("image")){b=a.image.width/a.image.height;var d=2*Math.PI*100/b;c=new THREE.CylinderGeometry(100,100,d,40,1,!0)}else c=new THREE.CylinderGeometry(100,100,200,40,1,!0);c.scale(-1,1,1);var e=new THREE.MeshBasicMaterial({side:THREE.FrontSide});a.hasOwnProperty("image")&&(e.map=this.createTexture(a,"image"));var f=new THREE.Mesh(c,e);this.scene.add(f)},animateStart:function(){"undefined"!=typeof performance&&performance.now()?this.timePrev=performance.now():this.timePrev=Date.now(),this.animating||this.loading||(this.animating=!0,this.animate())},animate:function(){return this.loading?void(this.animating=!1):(this.renderScene(),this.controlHotSpots(),this.controlCompass(),void(this.grabControl.enabled?(this.controlHoverGrabControl(),this.animationId=requestAnimationFrame(a.proxy(this.animate,this))):this.isTransition()||this.hoverGrabControl.enabled?(this.applyTransition(),this.controlHoverGrabControl(),this.animationId=requestAnimationFrame(a.proxy(this.animate,this))):this.animating=!1))},isTransition:function(){return this.autoRotate.enabled||this.yaw.time<this.yaw.duration||this.pitch.time<this.pitch.duration||this.zoom.time<this.zoom.duration?!0:!1},applyTransition:function(){"undefined"!=typeof performance&&performance.now()?this.timeNext=performance.now():this.timeNext=Date.now(),void 0===this.timePrev&&(this.timePrev=this.timeNext);var a=this.timeNext-this.timePrev,b=Date.now()-this.timeInteraction;this.autoRotate.enabled&&b>this.config.autoRotateInactivityDelay&&(this.yaw.value-=this.autoRotate.speed*a),this.applyInterpolation(this.yaw,a),this.applyInterpolation(this.pitch,a),this.applyInterpolation(this.zoom,a),this.pitch.value=Math.max(this.pitch.min,Math.min(this.pitch.max,this.pitch.value)),this.zoom.value=Math.max(this.zoom.min,Math.min(this.zoom.max,this.zoom.value)),this.timePrev=this.timeNext},resetTransition:function(){this.yaw.time=this.yaw.duration,this.pitch.time=this.pitch.duration,this.zoom.time=this.zoom.duration},resetScene:function(){this.animationId&&cancelAnimationFrame(this.animationId),this.renderer=null,this.scene=null,this.camera=null,this.container.empty()},renderScene:function(){this.camera.fov!=this.zoom.value&&(this.camera.fov=this.zoom.value,this.camera.updateProjectionMatrix()),this.camera.lookAt(this.getPitchYawPoint(this.pitch.value,this.yaw.value));var a=this.renderer.getSize();this.renderer.clear(),this.renderer.setViewport(0,0,a.width,a.height),this.renderer.render(this.scene,this.camera),"function"==typeof this.config.onCameraUpdate&&this.config.onCameraUpdate.call(this,this.yaw.value,this.pitch.value,this.zoom.value)},controlCompass:function(){if(this.config.compass&&this.sceneId&&null!=this.config.scenes[this.sceneId].compassNorthOffset){var a=this.config.scenes[this.sceneId].compassNorthOffset,b=a-this.yaw.value;this.controls.$compass.css({transform:"rotate("+b+"deg)"})}},controlHotSpots:function(){var a=this.controls.$view.width(),b=this.controls.$view.height(),c=new THREE.Frustum;c.setFromMatrix((new THREE.Matrix4).multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse));for(var d=this.hotSpots.length;d--;){var e=this.hotSpots[d];c.containsPoint(e.xyz)&&e.sceneOwnerId==this.sceneId?e.visible?this.updateHotSpots(this.camera,a,b,e):(e.visible=!0,e.$el.fadeIn(),e.$popover&&e.$popover.removeClass("ipnrm-hidden"),this.updateHotSpots(this.camera,a,b,e)):e.visible&&(e.visible=!1,e.$el.fadeOut(),e.$popover&&e.$popover.addClass("ipnrm-hidden"),this.updateHotSpots(this.camera,a,b,e)),e.$popover&&e.$popover.hasClass("ipnrm-active")&&!e.$popover.hasClass(this.config.popoverHideClass)&&this.showPopover(e)}},updateHotSpots:function(a,b,c,d){var e=this.getHotSpotScreenPos(d,a,b,c);d.$el.css({top:e.y-d.$el.height()/2,left:e.x-d.$el.width()/2})},getHotSpotScreenPos:function(a,b,c,d){var e=new THREE.Vector3(a.xyz.x,a.xyz.y,a.xyz.z);return e.project(b),e.x=(e.x+1)/2*c,e.y=-(e.y-1)/2*d,{x:e.x,y:e.y}},applyHandlers:function(){this.controls.$loadBtn.on("click.ipanorama",a.proxy(this.onLoadBtnClick,this)),this.controls.$sceneMenu.on("click.ipanorama",a.proxy(this.onSceneMenuClick,this)),this.controls.$scenePrev.on("click.ipanorama",a.proxy(this.onScenePrevClick,this)),this.controls.$sceneNext.on("click.ipanorama",a.proxy(this.onSceneNextClick,this)),this.controls.$zoomIn.on("click.ipanorama",a.proxy(this.onZoomIn,this)),this.controls.$zoomOut.on("click.ipanorama",a.proxy(this.onZoomOut,this)),this.controls.$share.on("click.ipanorama",a.proxy(this.onShare,this)),this.controls.$fullscreen.on("click.ipanorama",a.proxy(this.onFullScreen,this)),this.controls.$view.on("click.ipanorama",a.proxy(this.onMouseClick,this)),this.controls.$view.on("mousewheel.ipanorama DOMMouseScroll.ipanorama",a.proxy(this.onMouseWheel,this)),(this.config.showSceneThumbsCtrl||this.config.showSceneMenuCtrl)&&(this.controls.$sceneThumbs.find(".ipnrm-scene-thumb").on("click.ipanorama",a.proxy(this.onSceneThumbClick,this)),this.controls.$sceneThumbs.on("mousewheel.ipanorama DOMMouseScroll.ipanorama",a.proxy(this.onSceneThumbsWheel,this)),this.controls.$sceneThumbs.on("mousedown.ipanorama",a.proxy(this.onSceneThumbsGrabMouseDown,this)),this.controls.$sceneThumbs.on("touchstart.ipanorama",a.proxy(this.onSceneThumbsGrabTouchStart,this)),this.controls.$sceneThumbs.on("touchmove.ipanorama",a.proxy(this.onSceneThumbsGrabTouchMove,this)),this.controls.$sceneThumbs.on("touchend.ipanorama",a.proxy(this.onSceneThumbsGrabTouchEnd,this))),this.config.grab&&(this.controls.$view.on("mousedown.ipanorama",a.proxy(this.onGrabMouseDown,this)),this.controls.$view.on("touchstart.ipanorama",a.proxy(this.onGrabTouchStart,this)),this.controls.$view.on("touchmove.ipanorama",a.proxy(this.onGrabTouchMove,this)),this.controls.$view.on("touchend.ipanorama",a.proxy(this.onGrabTouchEnd,this))),this.config.showControlsOnHover&&(this.controls.$panorama.one("mousemove.ipanorama",a.proxy(this.onPanoramaEnter,this)),this.controls.$panorama.on("mouseenter.ipanorama",a.proxy(this.onPanoramaEnter,this)),this.controls.$panorama.on("mouseleave.ipanorama",a.proxy(this.onPanoramaLeave,this))),this.config.hoverGrab&&(this.controls.$panorama.on("mouseenter.ipanorama",a.proxy(this.onHoverGrabEnter,this)),this.controls.$panorama.on("mouseleave.ipanorama",a.proxy(this.onHoverGrabLeave,this))),this.controls.$panorama.on("blur.ipanorama",a.proxy(this.onBlur,this)),this.controls.$panorama.on("keydown.ipanorama",a.proxy(this.onKeyDown,this)),this.controls.$panorama.on("keyup.ipanorama",a.proxy(this.onKeyUp,this)),this.controls.$panorama.on("fullscreenchange.ipanorama mozfullscreenchange.ipanorama webkitfullscreenchange.ipanorama msfullscreenchange.ipanorama",a.proxy(this.onFullScreenChange,this)),a(window).on("resize.ipanorama-"+this.id,a.proxy(this.onResize,this)),a(window).on("blur.ipanorama-"+this.id,a.proxy(this.onBlur,this))},resetHandlers:function(){this.controls.$loadBtn.off("click.ipanorama"),this.controls.$sceneMenu.off("click.ipanorama"),this.controls.$scenePrev.off("click.ipanorama"),this.controls.$sceneNext.off("click.ipanorama"),this.controls.$zoomIn.off("click.ipanorama"),this.controls.$zoomOut.off("click.ipanorama"),this.controls.$share.off("click.ipanorama"),this.controls.$fullscreen.off("click.ipanorama"),this.controls.$view.off("click.ipanorama"),this.controls.$view.off("mousewheel.ipanorama DOMMouseScroll.ipanorama"),this.controls.$sceneThumbs.off("mousewheel.ipanorama DOMMouseScroll.ipanorama"),this.controls.$sceneThumbs.find(".ipnrm-scene-thumb").off("click.ipanorama"),this.config.grab&&(this.controls.$view.off("mousedown.ipanorama"),this.controls.$view.off("touchstart.ipanorama"),this.controls.$view.off("touchmove.ipanorama"),this.controls.$view.off("touchend.ipanorama")),this.config.showControlsOnHover&&(this.controls.$panorama.off("mouseenter.ipanorama"),this.controls.$panorama.off("mouseleave.ipanorama")),this.controls.$panorama.off("blur.ipanorama"),this.controls.$panorama.off("keydown.ipanorama"),this.controls.$panorama.off("keyup.ipanorama"),this.controls.$panorama.off("fullscreenchange.ipanorama mozfullscreenchange.ipanorama webkitfullscreenchange.ipanorama msfullscreenchange.ipanorama"),a(window).off("mousemove.ipanorama-"+this.id),a(window).off("mouseup.ipanorama-"+this.id),a(window).off("resize.ipanorama-"+this.id),a(window).off("blur.ipanorama-"+this.id)},onHotSpotSceneClick:function(a,b){b.preventDefault(),b.stopPropagation(),this.loadScene(a.sceneId)},onHotSpotClick:function(a,b){a.$popover&&a.$popover.hasClass("ipnrm-active")||b.stopImmediatePropagation(),this.showPopover(a)},onHotSpotEnter:function(a,b){this.showPopover(a)},onHotSpotLeave:function(b,c){if(b.$popover){var d=c.toElement||c.relatedTarget;0!==b.$popover.has(d).length||b.$popover.is(d)||b.$el.is(d)?b.$popover.one("mouseleave.ipanorama",a.proxy(this.onHotSpotLeave,this,b)):this.hidePopover(b)}},onPopoverHide:function(b,c){b.$popover&&(0===b.$popover.has(c.target).length||a(c.target).hasClass("ipnrm-close"))&&(a(c.target).hasClass("ipnrm-close")&&c.stopImmediatePropagation(),this.hidePopover(b))},onPopoverClick:function(a,b){a.$popover&&this.liftupPopover(a)},onFullScreenChange:function(){this.util().isiOS()||(document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen||document.msFullscreenElement?(this.controls.$panorama.addClass("ipnrm-fullscreen"),this.controls.$fullscreen.addClass("ipnrm-active")):(this.controls.$panorama.removeClass("ipnrm-fullscreen"),this.controls.$fullscreen.removeClass("ipnrm-active")))},toggleFullScreen:function(){if(this.util().isiOS())this.controls.$panorama.hasClass("ipnrm-fullscreen")?(this.controls.$panorama.removeClass("ipnrm-fullscreen ipnrm-fullscreen-emulation"),this.controls.$fullscreen.removeClass("ipnrm-active")):(this.controls.$panorama.addClass("ipnrm-fullscreen ipnrm-fullscreen-emulation"),this.controls.$fullscreen.addClass("ipnrm-active")),this.refreshLayout();else if(this.controls.$fullscreen.hasClass("ipnrm-active"))try{document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}catch(a){}else try{var b=this.controls.$panorama.get(0);b.requestFullscreen?b.requestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.webkitRequestFullscreen?b.webkitRequestFullscreen():b.msRequestFullscreen&&b.msRequestFullscreen()}catch(a){}},onFullScreen:function(){this.toggleFullScreen()},onShare:function(a){"function"==typeof this.config.onShare&&this.config.onShare.call(this,a)},onMouseClick:function(a){this.isLoading()||this.getHotSpotParameters(a)},onGrabMouseDown:function(b){b.preventDefault(),b.stopPropagation(),this.isLoading()||this.hotSpotSetupControl.enabled||(this.controls.$panorama.focus(),this.applyGrabControl(b),a(window).on("mousemove.ipanorama-"+this.id,a.proxy(this.onGrabMouseMove,this)),a(window).on("mouseup.ipanorama-"+this.id,a.proxy(this.onGrabMouseUp,this)))},onGrabMouseMove:function(a){this.updateGrabControl(a)},onGrabMouseUp:function(b){this.resetGrabControl(b),a(window).off("mousemove.ipanorama-"+this.id),a(window).off("mouseup.ipanorama-"+this.id)},onGrabTouchStart:function(a){this.isLoading()||this.applyGrabControl(a)},onGrabTouchMove:function(a){if(!this.isLoading()&&(a.preventDefault(),
this.grabControl.enabled)){var b=this.getMousePosition(a.originalEvent.targetTouches[0]);this.yaw.valuePrev=this.yaw.value,this.pitch.valuePrev=this.pitch.value,this.yaw.value=(this.grabControl.x-b.x)*this.config.grabCoef+this.grabControl.yawSaved,this.pitch.value=(b.y-this.grabControl.y)*this.config.grabCoef+this.grabControl.pitchSaved,this.pitch.value=Math.max(this.pitch.min,Math.min(this.pitch.max,this.pitch.value))}},onGrabTouchEnd:function(a){this.grabControl.enabled=!1},onHoverGrabEnter:function(b){this.isLoading()||this.hoverGrabControl.enabled||(this.hoverGrabControl.enabled=!0,this.controls.$panorama.on("mousemove.ipanorama",a.proxy(this.onHoverGrabMove,this)),this.resetTransition(),this.animateStart())},onHoverGrabLeave:function(a){this.hoverGrabControl.enabled&&(this.hoverGrabControl.enabled=!1,this.controls.$panorama.off("mousemove.ipanorama"))},onHoverGrabMove:function(a){if(!this.isLoading()){var b=this.getMousePositionPower(a);this.hoverGrabControl.power=b,this.hoverGrabControl.enabled&&!this.grabControl.enabled&&(this.yaw.valuePrev=this.yaw.value,this.pitch.valuePrev=this.pitch.value,this.yaw.value=this.hoverGrabControl.yawSaved+b.x*this.config.hoverGrabYawCoef,this.pitch.value=this.hoverGrabControl.pitchSaved+b.y*this.config.hoverGrabPitchCoef,this.pitch.value=Math.max(this.pitch.min,Math.min(this.pitch.max,this.pitch.value)))}},onPanoramaEnter:function(a){this.controls.$panorama.removeClass("ipnrm-hide-controls"),this.refreshLayout()},onPanoramaLeave:function(a){this.controls.$panorama.addClass("ipnrm-hide-controls"),this.refreshLayout()},onKeyDown:function(a){return this.isLoading()?void 0:(this.autoRotate.enabled=!1,this.timeInteraction=Date.now(),a.ctrlKey&&this.config.hotSpotSetup&&!this.grabControl.enabled?void this.applyHotSpotSetupControl():void(38===a.keyCode&&this.config.keyboardNav===!0?this.setPitch(this.pitch.value+10):40===a.keyCode&&this.config.keyboardNav===!0?this.setPitch(this.pitch.value-10):37===a.keyCode&&this.config.keyboardNav===!0?this.setYaw(this.yaw.value-10):39===a.keyCode&&this.config.keyboardNav===!0?this.setYaw(this.yaw.value+10):189!==a.keyCode&&109!==a.keyCode||this.config.keyboardZoom!==!0?187!==a.keyCode&&107!==a.keyCode||this.config.keyboardZoom!==!0||this.setZoom(this.zoom.value-10):this.setZoom(this.zoom.value+10)))},onKeyUp:function(a){this.config.hotSpotSetup&&this.resetHotSpotSetupControl(),this.config.autoRotate&&(this.autoRotate.enabled=!0,this.timeInteraction=Date.now(),this.animateStart())},resize:function(){if(!this.isLoading()){var a=this.controls.$view.width(),b=this.controls.$view.height();this.aspect=a/b,this.camera.aspect=this.aspect,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b),this.animateStart()}},refreshLayout:function(){this.resize(),this.onFullScreenChange()},onResize:function(a){this.refreshLayout()},onBlur:function(a){this.resetHotSpotSetupControl(),this.timePrev=void 0},onLoadBtnClick:function(a){this.controls.$loadBtn.hide(),this.loadScene(this.config.sceneId)},onSceneThumbClick:function(b){var c=a(b.currentTarget).attr("data-sceneid");this.loadScene(c)},onSceneThumbsGrabMouseDown:function(b){b.preventDefault(),b.stopPropagation(),this.applySceneThumbsGrabControl(b),a(window).on("mousemove.ipanorama-"+this.id+"-thumbs",a.proxy(this.onSceneThumbsGrabMouseMove,this)),a(window).on("mouseup.ipanorama-"+this.id+"-thumbs",a.proxy(this.onSceneThumbsGrabMouseUp,this)),console.log("onSceneThumbsGrabMouseDown")},onSceneThumbsGrabMouseMove:function(a){this.updateSceneThumbsGrabControl(a)},onSceneThumbsGrabMouseUp:function(b){this.resetSceneThumbsGrabControl(b),a(window).off("mousemove.ipanorama-"+this.id+"-thumbs"),a(window).off("mouseup.ipanorama-"+this.id+"-thumbs"),console.log("onSceneThumbsGrabMouseUp")},onSceneThumbsGrabTouchStart:function(a){this.applySceneThumbsGrabControl(a)},onSceneThumbsGrabTouchMove:function(a){a.preventDefault(),this.updateSceneThumbsGrabControl(a)},onSceneThumbsGrabTouchEnd:function(a){this.resetSceneThumbsGrabControl(a)},onSceneThumbsWheel:function(a){a.preventDefault();var a=a.originalEvent,b=1;a.wheelDeltaY?b=a.wheelDeltaY>0?-1:1:a.wheelDelta?b=a.wheelDelta>0?-1:1:a.detail&&(b=a.detail>0?1:-1);var c=this.sceneThumbIndex+b;0>c||this.sceneIdThumbsArray.length<=1?c=0:c>=this.sceneIdThumbsArray.length-1&&(c=this.sceneIdThumbsArray.length-1),this.sceneThumbIndex=c,this.moveToSceneThumb(c)},moveToSceneThumb:function(a){var b=this.sceneIdThumbsArray[a],c=this.controls.$sceneThumbsInner.find(".ipnrm-scene-thumb[data-sceneid='"+b+"']"),d=this.getOffsetRect(this.controls.$sceneThumbsInner),e=c.length?this.getOffsetRect(c):0,f=c.length?this.getMargins(c):0,g=d.top-(e.top-f.top),h=d.left-(e.left-f.left);this.sceneThumbsControl.topSaved=g,this.sceneThumbsControl.leftSaved=h,this.updateSceneThumbs(g,h)},updateSceneThumbs:function(a,b){this.config.sceneThumbsVertical?this.controls.$sceneThumbsInner.css({transform:"translate3d(0px, "+a+"px, 0px)","-webkit-transform":"translate3d(0px, "+a+"px, 0px)"}):this.controls.$sceneThumbsInner.css({transform:"translate3d("+b+"px, 0px, 0px)","-webkit-transform":"translate3d("+b+"px, 0px, 0px)"})},onSceneMenuClick:function(a){this.controls.$sceneThumbs.toggleClass("ipnrm-active"),this.controls.$sceneThumbs.hasClass("ipnrm-active")?(this.controls.$sceneMenu.addClass("ipnrm-active"),this.controls.$panorama.addClass("ipnrm-scene-thumbs-active")):(this.controls.$sceneMenu.removeClass("ipnrm-active"),this.controls.$panorama.removeClass("ipnrm-scene-thumbs-active"),this.config.showSceneThumbsCtrl=!1),this.refreshSceneThumb(this.sceneId),this.refreshLayout()},onScenePrevClick:function(a){var b=this.getPrevSceneId(this.sceneId);b?this.loadScene(b):this.config.sceneNextPrevLoop&&this.loadScene(this.getLastSceneId())},onSceneNextClick:function(a){var b=this.getNextSceneId(this.sceneId);b?this.loadScene(b):this.config.sceneNextPrevLoop&&this.loadScene(this.getFirstSceneId())},onZoomIn:function(a){this.isLoading()||this.setZoom(this.zoom.value-10)},onZoomOut:function(a){this.isLoading()||this.setZoom(this.zoom.value+10)},onMouseWheel:function(a){if(a.preventDefault(),!this.isLoading()){var a=a.originalEvent;a.wheelDeltaY?this.config.mouseWheelRotate?this.setYaw(this.yaw.value-a.wheelDeltaY*this.config.mouseWheelRotateCoef):this.config.mouseWheelZoom&&this.setZoom(this.zoom.value-a.wheelDeltaY*this.config.mouseWheelZoomCoef):a.wheelDelta?this.config.mouseWheelRotate?this.setYaw(this.yaw.value-a.wheelDelta*this.config.mouseWheelRotateCoef):this.config.mouseWheelZoom&&this.setZoom(this.zoom.value-a.wheelDelta*this.config.mouseWheelZoomCoef):a.detail&&(this.config.mouseWheelRotate?this.setYaw(this.yaw.value+a.detail*this.config.mouseWheelRotateCoef*100):this.config.mouseWheelZoom&&this.setZoom(this.zoom.value+a.detail*this.config.mouseWheelZoomCoef*100))}},setYaw:function(a,b){this.yaw.valuePrev=this.yaw.value,this.yaw.valueNext=a,this.yaw.time=0,this.yaw.duration=b?b:1e3,this.animateStart()},setPitch:function(a,b){this.pitch.valuePrev=this.pitch.value,this.pitch.valueNext=a,this.pitch.time=0,this.pitch.duration=b?b:1e3,this.animateStart()},setZoom:function(a,b){this.zoom.valuePrev=this.zoom.value,this.zoom.valueNext=a,this.zoom.time=0,this.zoom.duration=b?b:500,this.animateStart()},applySceneThumbsGrabControl:function(a){var b={x:0,y:0};window.TouchEvent&&a.originalEvent instanceof TouchEvent?b=this.getMousePosition(a.originalEvent.targetTouches[0]):(b.x=a.clientX,b.y=a.clientY),this.sceneThumbsControl.grab=!0,this.sceneThumbsControl.x=b.x,this.sceneThumbsControl.y=b.y,this.sceneThumbsControl.top=this.sceneThumbsControl.topSaved,this.sceneThumbsControl.left=this.sceneThumbsControl.leftSaved,this.controls.$sceneThumbsInner.addClass("ipnrm-notransition")},updateSceneThumbsGrabControl:function(a){if(this.sceneThumbsControl.grab){var b={x:0,y:0};window.TouchEvent&&a.originalEvent instanceof TouchEvent?b=this.getMousePosition(a.originalEvent.targetTouches[0]):(b.x=a.clientX,b.y=a.clientY),this.sceneThumbsControl.top=this.sceneThumbsControl.topSaved+b.y-this.sceneThumbsControl.y,this.sceneThumbsControl.left=this.sceneThumbsControl.leftSaved+b.x-this.sceneThumbsControl.x,this.updateSceneThumbs(this.sceneThumbsControl.top,this.sceneThumbsControl.left)}},resetSceneThumbsGrabControl:function(b){if(this.sceneThumbsControl.grab){this.sceneThumbsControl.grab=!1,this.sceneThumbsControl.topSaved=this.sceneThumbsControl.top,this.sceneThumbsControl.leftSaved=this.sceneThumbsControl.left;var c=this,d=0;this.controls.$sceneThumbsInner.find(".ipnrm-scene-thumb").each(function(b){var e=a(this),f=c.getOffsetRect(c.controls.$sceneThumbs),g=c.getOffsetRect(e),h=0;return h=c.config.sceneThumbsVertical?g.top+g.height/2-f.top:g.left+g.width/2-f.left,d=b,h>0?!1:void 0}),this.controls.$sceneThumbsInner[0].offsetHeight,this.controls.$sceneThumbsInner.removeClass("ipnrm-notransition"),this.sceneThumbIndex=d,this.moveToSceneThumb(d)}},applyGrabControl:function(a){this.setViewCursorShape("ipnrm-grabbing"),this.autoRotate.enabled=!1,this.timeInteraction=Date.now();var b={x:0,y:0};window.TouchEvent&&a.originalEvent instanceof TouchEvent?b=this.getMousePosition(a.originalEvent.targetTouches[0]):(b.x=a.clientX,b.y=a.clientY),this.grabControl.enabled=!0,this.grabControl.x=b.x,this.grabControl.y=b.y,this.grabControl.yawSaved=this.yaw.value,this.grabControl.pitchSaved=this.pitch.value,this.resetTransition(),this.animateStart()},updateGrabControl:function(a){if(this.grabControl.enabled){this.timeInteraction=Date.now();var b={x:0,y:0};window.TouchEvent&&a.originalEvent instanceof TouchEvent?b=this.getMousePosition(a.originalEvent.targetTouches[0]):(b.x=a.clientX,b.y=a.clientY),this.yaw.valuePrev=this.yaw.value,this.pitch.valuePrev=this.pitch.value,this.yaw.value=(this.grabControl.x-b.x)*this.config.grabCoef+this.grabControl.yawSaved,this.pitch.value=(b.y-this.grabControl.y)*this.config.grabCoef+this.grabControl.pitchSaved,this.pitch.value=Math.max(this.pitch.min,Math.min(this.pitch.max,this.pitch.value))}},resetGrabControl:function(a){if(this.grabControl.enabled){this.config.autoRotate&&(this.autoRotate.enabled=!0),this.grabControl.enabled=!1,this.setViewCursorShape("ipnrm-grab"),this.controlHoverGrabControl();var b=this.yaw.value-this.grabControl.yawSaved,c=this.pitch.value-this.grabControl.pitchSaved;this.setYaw(this.yaw.value+1*Math.sign(b),500),this.setPitch(this.pitch.value+1*Math.sign(c),500)}},controlHoverGrabControl:function(){if(this.config.hoverGrab&&this.hoverGrabControl.power){var a=this.hoverGrabControl.power,b=this.yaw.value-a.x*this.config.hoverGrabYawCoef,c=this.pitch.value-a.y*this.config.hoverGrabPitchCoef;c=Math.max(this.pitch.min,Math.min(this.pitch.max,c)),this.hoverGrabControl.yawSaved=b,this.hoverGrabControl.pitchSaved=c}},applyHotSpotSetupControl:function(){this.hotSpotSetupControl.enabled||(this.setViewCursorShape("ipnrm-target"),this.hotSpotSetupControl.enabled=!0)},getHotSpotParameters:function(a){if(this.hotSpotSetupControl.enabled||"function"==typeof this.config.onHotSpotSetup){var b=this.getHotSpotYawPitch(a);this.hotSpotSetupControl.enabled&&console.log("yaw: "+b.yaw+", pitch: "+b.pitch+", camera yaw: "+this.yaw.value+", camera pitch: "+this.pitch.value+", camera zoom: "+this.zoom.value),"function"==typeof this.config.onHotSpotSetup&&this.config.onHotSpotSetup.call(this,b.yaw,b.pitch,this.yaw.value,this.pitch.value,this.zoom.value,a)}},getHotSpotYawPitch:function(a){var b=this.controls.$view.offset(),c=a.pageX-b.left,d=a.pageY-b.top,e=this.controls.$view.get(0).getBoundingClientRect(),f=e.right-e.left,g=e.bottom-e.top,h=c/f*2-1,i=1-d/g*2,j=new THREE.Vector3(h,i,.5);j.unproject(this.camera);var k=j.sub(this.camera.position).normalize(),l=Math.atan(k.x/k.z),m=Math.atan(k.y/Math.sqrt(k.z*k.z+k.x*k.x));return l=-THREE.Math.radToDeg(l),m=THREE.Math.radToDeg(m),k.z<=0?l=180+l:k.x>0&&(l=360+l),{yaw:l,pitch:m}},resetHotSpotSetupControl:function(){this.setViewCursorShape("ipnrm-grab"),this.hotSpotSetupControl.enabled=!1},setViewCursorShape:function(a){this.controls.$view.removeClass("ipnrm-grab"),this.controls.$view.removeClass("ipnrm-grabbing"),this.controls.$view.removeClass("ipnrm-target"),(this.config.grab||"ipnrm-target"==a)&&this.controls.$view.addClass(a)},lookAt:function(a,b){this.setYaw(a,500),this.setPitch(b,500)},isLoading:function(){return this.loading||!this.scene},getFirstSceneId:function(){var a=null;for(var b in this.config.scenes)if(this.config.scenes.hasOwnProperty(b)){a=b;break}return a},getLastSceneId:function(){var a=null;for(var b in this.config.scenes)this.config.scenes.hasOwnProperty(b)&&(a=b);return a},getPrevSceneId:function(a){var b=!1,c=null;for(var d in this.config.scenes)if(this.config.scenes.hasOwnProperty(d)){if(d==a&&(b=!0),b)break;c=d}return c},getNextSceneId:function(a){var b=!1,c=null;for(var d in this.config.scenes)if(this.config.scenes.hasOwnProperty(d)){if(b){c=d;break}d==a&&(b=!0)}return c},getOffsetRect:function(a){var b=a.get(0).getBoundingClientRect(),c=document.body,d=document.documentElement,e=window.pageYOffset||d.scrollTop||c.scrollTop,f=window.pageXOffset||d.scrollLeft||c.scrollLeft,g=d.clientTop||c.clientTop||0,h=d.clientLeft||c.clientLeft||0,i=b.top+e-g,j=b.left+f-h;return{top:Math.round(i),left:Math.round(j),width:b.width,height:b.height}},getMargins:function(a){var b=parseInt(a.css("margin-top"),10),c=parseInt(a.css("margin-bottom"),10),d=parseInt(a.css("margin-left"),10),e=parseInt(a.css("margin-right"),10);return isNaN(b)&&(b=0),isNaN(c)&&(c=0),isNaN(d)&&(d=0),isNaN(e)&&(e=0),{top:b,left:d,bottom:c,right:e}},getPitchYawPoint:function(a,b){var c=new THREE.Vector3(0,0,0);return c.x=Math.sin(THREE.Math.degToRad(180-b))*Math.cos(THREE.Math.degToRad(180-a)),c.y=Math.sin(THREE.Math.degToRad(180-a)),c.z=Math.cos(THREE.Math.degToRad(180-b))*Math.cos(THREE.Math.degToRad(180-a)),c},getMousePositionPower:function(a){var b=this.controls.$panorama.get(0).getBoundingClientRect(),c={},d=(b.right-b.left)/2,e=(b.bottom-b.top)/2,f=document.body,g=document.documentElement,h=window.pageYOffset||g.scrollTop||f.scrollTop,i=window.pageXOffset||g.scrollLeft||f.scrollLeft,j=g.clientTop||f.clientTop||0,k=g.clientLeft||f.clientLeft||0,l=b.top+h-j,m=b.left+i-k,l=Math.round(l),m=Math.round(m),l=a.pageY-l,m=a.pageX-m;return c.x=(m-d)/d,c.y=(e-l)/e,c.x=c.x<-1?-1:c.x>1?1:c.x,c.y=c.y<-1?-1:c.y>1?1:c.y,c},applyInterpolation:function(a,b){if(a.time<a.duration){a.time+=b;var c=a.time/a.duration;a.value=a.valuePrev+(a.valueNext-a.valuePrev)*c}},createTexture:function(a,b){var c=new THREE.Texture;return c.image=a[b],c.needsUpdate=!0,c},getMousePosition:function(a){var b=this.controls.$panorama.get(0).getBoundingClientRect(),c={};return c.x=a.clientX-b.left,c.y=a.clientY-b.top,c},showLoadInfo:function(){this.controls.$loadProgressBar.css({width:0}),this.controls.$loadInfo.css({display:""}).fadeTo("slow",1)},hideLoadInfo:function(){this.controls.$loadInfo.fadeTo("slow",0,function(){a(this).css({display:"none"})})},applyScenePrevNextCtrls:function(a){if(!this.config.sceneNextPrevLoop){var b=this.getPrevSceneId(a),c=this.getNextSceneId(a);b?this.controls.$scenePrev.removeClass("ipnrm-disable"):this.controls.$scenePrev.addClass("ipnrm-disable"),c?this.controls.$sceneNext.removeClass("ipnrm-disable"):this.controls.$sceneNext.addClass("ipnrm-disable")}},applySceneThumbs:function(a){this.config.sceneThumbsVertical?this.controls.$panorama.addClass("ipnrm-scene-thumbs-v").removeClass("ipnrm-scene-thumbs-h"):this.controls.$panorama.addClass("ipnrm-scene-thumbs-h").removeClass("ipnrm-scene-thumbs-v"),this.config.showSceneThumbsCtrl&&(this.controls.$sceneThumbs.addClass("ipnrm-active"),this.controls.$panorama.addClass("ipnrm-scene-thumbs-active")),this.refreshSceneThumb(a)},refreshSceneThumb:function(a){if(this.controls.$sceneThumbs.hasClass("ipnrm-active")){this.controls.$sceneThumbs.find(".ipnrm-scene-thumb.ipnrm-active").removeClass("ipnrm-active"),this.controls.$sceneThumbs.find(".ipnrm-scene-thumb[data-sceneid='"+a+"']").addClass("ipnrm-active");var b=this.sceneIdThumbsArray.indexOf(a);b>=0&&this.moveToSceneThumb(b)}},applyControls:function(a){this.controls.$toolbar.fadeIn("slow"),this.config.showSceneMenuCtrl?(this.controls.$sceneMenu.fadeIn("slow"),this.controls.$panorama.removeClass("ipnrm-no-scene-menu-ctrl")):this.controls.$panorama.addClass("ipnrm-no-scene-menu-ctrl"),this.config.showSceneNextPrevCtrl?(this.controls.$sceneNext.fadeIn("slow"),this.controls.$scenePrev.fadeIn("slow"),this.controls.$panorama.removeClass("ipnrm-no-scene-nextprev-ctrl")):this.controls.$panorama.addClass("ipnrm-no-scene-nextprev-ctrl"),this.config.showZoomCtrl?(this.controls.$zoomIn.fadeIn("slow"),this.controls.$zoomOut.fadeIn("slow"),this.controls.$panorama.removeClass("ipnrm-no-zoom-ctrl")):this.controls.$panorama.addClass("ipnrm-no-zoom-ctrl"),this.config.showShareCtrl?(this.controls.$share.fadeIn("slow"),this.controls.$panorama.removeClass("ipnrm-no-share-ctrl")):this.controls.$panorama.addClass("ipnrm-no-share-ctrl"),this.config.showFullscreenCtrl?(this.controls.$fullscreen.fadeIn("slow"),this.controls.$panorama.removeClass("ipnrm-no-fullscreen-ctrl")):this.controls.$panorama.addClass("ipnrm-no-fullscreen-ctrl"),this.config.compass&&null!=this.config.scenes[a].compassNorthOffset?(this.controls.$compass.fadeIn("slow"),this.controls.$panorama.removeClass("ipnrm-no-compass-ctrl")):(this.controls.$compass.fadeOut("slow"),this.controls.$panorama.addClass("ipnrm-no-compass-ctrl")),this.applyScenePrevNextCtrls(a),this.applySceneThumbs(a),this.applyTitle(a)},applyTitle:function(b){if(this.config.title){var c=this.config.scenes[b];if(c.title){var d="function"==typeof c.title?c.title.call(b):c.title;this.controls.$title.empty()[c.titleHtml?"string"==typeof d?"html":"append":"text"](d),this.controls.$title.fadeIn("slow")}else if(c.titleSelector){var e=a(c.titleSelector);this.controls.$title.empty()[c.titleHtml?"html":"text"](c.titleHtml?e.html():e.text()),this.controls.$title.fadeIn("slow")}else this.controls.$title.fadeOut("slow")}},showMessage:function(b){this.controls.$info.html(b),this.controls.$info.fadeIn(),setTimeout(a.proxy(function(){this.controls.$info.fadeOut()},this),5e3)},destroy:function(){this.resetHotSpots(),this.resetHandlers(),this.resetScene()},util:function(){return null!=this._util?this._util:this._util=new c}},a.fn.ipanorama=function(c,e){return this.each(function(){var f=a(this),g=f.data(d),h=a.isPlainObject(c)?c:{};if("destroy"==c)return g?(f.removeData(d),void g.destroy()):void console.error("Calling 'destroy' method on not initialized instance is forbidden");if("loadscene"==c)return g?e&&e.hasOwnProperty("sceneId")?void g.loadScene(e.sceneId):void console.error("Calling 'loadscene' method without the 'sceneId' parameter is forbidden"):void console.error("Calling 'loadscene' method on not initialized instance is forbidden");if("loadhotspots"==c)return g?e&&e.hasOwnProperty("sceneId")&&e.hasOwnProperty("hotSpots")?void g.loadHotSpots(e.sceneId,e.hotSpots):void console.error("Calling 'loadhotspots' method without the 'sceneId' and 'hotSpots' parameter is forbidden"):void console.error("Calling 'loadhotspots' method on not initialized instance is forbidden");if("lookat"==c)return g?e&&e.hasOwnProperty("yaw")&&e.hasOwnProperty("pitch")?void g.lookAt(e.yaw,e.pitch):void console.error("Calling 'lookat' method without the 'yaw' and 'pitch' parameter is forbidden"):void console.error("Calling 'lookat' method on not initialized instance is forbidden");if("resize"==c)return g?void g.resize():void console.error("Calling 'resize' method on not initialized instance is forbidden");if("fullscreen"==c)return g?void g.toggleFullScreen():void console.error("Calling 'fullscreen' method on not initialized instance is forbidden");if(g){var i=a.extend({},g.config,h);g.init(f,i)}else{var i=a.extend({},b.prototype.defaults,h);g=new b(f,i),f.data(d,g)}})}}(window.jQuery);